<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工具貸出管理システム</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; padding: 20px; 
      background: #f5f5f5;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 8px; 
      padding: 30px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #333; 
      text-align: center; 
      margin-bottom: 30px; 
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }
    h3 { 
      color: #555; 
      border-bottom: 2px solid #ddd; 
      padding-bottom: 8px; 
      margin-top: 30px;
    }
    
    .csv-section {
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: 5px; 
      margin-bottom: 25px; 
      border: 1px solid #ddd;
    }
    .csv-section input[type="file"] { 
      padding: 8px; 
      margin: 10px 10px 10px 0; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      background: white; 
      width: 300px;
    }
    .csv-section button {
      background: #007bff; 
      color: white; 
      padding: 10px 20px;
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    .csv-section button:hover { 
      background: #0056b3; 
    }
    .csv-section button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 25px;
      border: 1px solid #ddd;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 12px; 
      text-align: center; 
    }
    th { 
      background: #f8f9fa; 
      font-weight: bold;
      color: #495057;
    }
    tr:nth-child(even) { 
      background: #f8f9fa; 
    }
    tr:hover { 
      background: #e9ecef; 
    }
    
    img.icon { 
      width: 40px; 
      height: 40px; 
      object-fit: contain;
      border-radius: 3px;
    }
    
    .tool-actions button { 
      margin: 2px; 
      padding: 6px 12px;
      border: none; 
      border-radius: 3px; 
      cursor: pointer;
      font-size: 12px;
    }
    .btn-borrow { 
      background: #28a745; 
      color: white; 
    }
    .btn-borrow:hover { 
      background: #218838; 
    }
    .btn-return { 
      background: #ffc107; 
      color: #212529; 
    }
    .btn-return:hover { 
      background: #e0a800; 
    }
    
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.4);
    }
    .modal-inner {
      background: white; 
      border-radius: 5px; 
      max-width: 400px; 
      margin: 15% auto; 
      padding: 20px; 
      position: relative;
      border: 1px solid #ddd;
    }
    .close-btn {
      position: absolute; 
      top: 10px; 
      right: 15px; 
      cursor: pointer; 
      font-size: 20px; 
      color: #aaa;
    }
    .close-btn:hover { 
      color: #000; 
    }
    
    .modal form label {
      display: block; 
      margin: 10px 0 5px 0; 
      font-weight: bold;
    }
    .modal form select, .modal form input {
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 3px;
      box-sizing: border-box;
    }
    .modal form button {
      width: 100%; 
      background: #007bff; 
      color: white; 
      padding: 10px; 
      border: none; 
      border-radius: 3px; 
      cursor: pointer;
      margin-top: 15px;
      font-size: 14px;
    }
    .modal form button:hover { 
      background: #0056b3; 
    }

    .no-data {
      color: #6c757d; 
      font-style: italic; 
      text-align: center;
      padding: 20px;
    }

    .stock-low { color: #dc3545; font-weight: bold; }
    .stock-ok { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 工具貸し出し管理システム</h1>
    
    <div class="csv-section">
      <h4>📁 工具マスタCSVファイル読み込み</h4>
      <p><strong>CSVフォーマット:</strong> 工具名,本数,画像ファイル名</p>
      <input type="file" id="csvInput" accept=".csv">
      <button id="loadCsvBtn" onclick="loadSelectedCSV()" disabled>読み込み</button>
      <p style="font-size: 14px; color: #666; margin-top: 10px;">
        例: ドライバー,10,driver.png
      </p>
    </div>

    <h3>📋 工具一覧</h3>
    <table id="toolTable">
      <thead>
        <tr>
          <th>画像</th>
          <th>工具名</th>
          <th>在庫</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4" class="no-data">
            CSVファイルを読み込んでください
          </td>
        </tr>
      </tbody>
    </table>

    <h3>📊 貸し出し状況一覧</h3>
    <div id="statusDiv">
      <p class="no-data">CSVファイルを読み込んでください</p>
    </div>

    <h3>📜 貸出・返却 履歴</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>日時</th>
          <th>クラス</th>
          <th>工具名</th>
          <th>操作</th>
          <th>本数</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5" class="no-data">
            履歴はありません
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- モーダル -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <span class="close-btn" onclick="closeModal()">×</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    // プリセットのクラス名一覧
    const CLASS_LIST = ["1", "2", "3", "4", "5", "6", "7", "8"];

    // グローバル変数
    let tools = [];
    let borrowStatus = {}; // {tool名: {class名:本数, ...}, ...}
    let toolStock = {}; // {tool名: 在庫数}
    let history = [];
    let selectedFile = null;
    
    // localStorageキー
    const STORAGE_KEY = "toolsystem-data-v2";

    // デバッグログ（コンソールのみ）
    function debugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleString('ja-JP');
      const logMessage = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
      
      switch(type) {
        case 'error':
          console.error(logMessage);
          break;
        case 'warning':
          console.warn(logMessage);
          break;
        case 'success':
          console.log(`%c${logMessage}`, 'color: green');
          break;
        default:
          console.log(logMessage);
      }
    }

    // ファイル選択時の処理
    document.getElementById('csvInput').addEventListener('change', function(e) {
      debugLog('ファイル選択イベントが発生しました');
      
      const file = e.target.files[0];
      const loadBtn = document.getElementById('loadCsvBtn');
      
      if (!file) {
        debugLog('ファイルが選択されていません', 'warning');
        selectedFile = null;
        loadBtn.disabled = true;
        return;
      }
      
      if (!file.name.toLowerCase().endsWith('.csv')) {
        debugLog('CSVファイル以外が選択されました', 'warning');
        alert('CSVファイルを選択してください');
        e.target.value = '';
        selectedFile = null;
        loadBtn.disabled = true;
        return;
      }
      
      selectedFile = file;
      loadBtn.disabled = false;
      debugLog(`CSVファイル選択完了: ${file.name} (${file.size} bytes)`);
    });

    // CSV読み込みボタンの処理
    function loadSelectedCSV() {
      if (!selectedFile) {
        debugLog('読み込み対象のファイルがありません', 'error');
        return;
      }
      
      debugLog(`CSVファイル読み込み開始: ${selectedFile.name}`);
      
      const reader = new FileReader();
      
      reader.onloadstart = function() {
        debugLog('ファイル読み込み処理開始');
        document.getElementById('loadCsvBtn').disabled = true;
        document.getElementById('loadCsvBtn').textContent = '読み込み中...';
      };
      
      reader.onload = function(evt) {
        const text = evt.target.result;
        debugLog(`ファイル読み込み完了: ${text.length} 文字`, 'success');
        parseAndLoadCSV(text);
        
        document.getElementById('loadCsvBtn').disabled = false;
        document.getElementById('loadCsvBtn').textContent = '読み込み';
      };
      
      reader.onerror = function(error) {
        debugLog(`ファイル読み込みエラー: ${error}`, 'error');
        alert('ファイル読み込みに失敗しました');
        
        document.getElementById('loadCsvBtn').disabled = false;
        document.getElementById('loadCsvBtn').textContent = '読み込み';
      };
      
      reader.readAsText(selectedFile, "UTF-8");
    }

    // CSV解析
    function parseAndLoadCSV(csv) {
      try {
        debugLog('CSV解析を開始');
        
        const lines = csv.trim().split(/\r?\n/);
        debugLog(`CSVファイル: ${lines.length} 行検出`);
        
        if (lines.length < 2) {
          throw new Error('CSVファイルにデータが不足しています（ヘッダー + データ行が必要）');
        }
        
        const header = lines[0].replace(/\s/g, '').split(',');
        debugLog(`ヘッダー: ${header.join(', ')}`);
        
        // 柔軟なヘッダー検索
        const nameIndex = header.findIndex(h => 
          h.includes('工具') || h.includes('名前') || h.includes('name') || h === 'tool'
        );
        const stockIndex = header.findIndex(h => 
          h.includes('本数') || h.includes('数量') || h.includes('stock') || h.includes('count')
        );
        const imgIndex = header.findIndex(h => 
          h.includes('画像') || h.includes('ファイル') || h.includes('image') || h.includes('img')
        );
        
        if (nameIndex === -1) {
          throw new Error('工具名の列が見つかりません');
        }
        if (stockIndex === -1) {
          throw new Error('本数の列が見つかりません');
        }
        
        debugLog(`列インデックス - 工具名: ${nameIndex}, 本数: ${stockIndex}, 画像: ${imgIndex}`);
        
        tools = [];
        borrowStatus = {};
        toolStock = {};
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 1; i < lines.length; i++) {
          try {
            const row = lines[i].split(',');
            const toolname = row[nameIndex]?.trim();
            const stock = parseInt(row[stockIndex]?.trim() || "0", 10);
            const img = imgIndex >= 0 ? (row[imgIndex]?.trim() || '') : '';
            
            if (!toolname) {
              debugLog(`行 ${i + 1}: 工具名が空です - スキップ`, 'warning');
              continue;
            }
            
            if (isNaN(stock) || stock < 0) {
              debugLog(`行 ${i + 1}: 本数が無効です (${row[stockIndex]}) - 0に設定`, 'warning');
            }
            
            const finalStock = Math.max(stock, 0);
            tools.push({ name: toolname, stock: finalStock, img:img });
            borrowStatus[toolname] = {};
            toolStock[toolname] = finalStock;
            successCount++;
            
            debugLog(`工具追加: ${toolname} (在庫: ${finalStock}, 画像: ${img || 'なし'})`, 'success');
            
          } catch (error) {
            errorCount++;
            debugLog(`行 ${i + 1} 解析エラー: ${error.message}`, 'error');
          }
        }
        
        debugLog(`CSV読み込み完了: 成功 ${successCount}件, エラー ${errorCount}件`, 'success');
        
        // 既存データを保持したまま状態復元
        loadFromStorage();
        
        // UI更新
        renderTools();
        renderStatus();
        renderHistory();
        
        // 完了通知
        alert(`CSV読み込み完了！${successCount}個の工具を登録しました`);
        
        if (errorCount > 0) {
          alert(`${errorCount}件のエラーがありました。詳細はブラウザのコンソールを確認してください`);
        }
        
      } catch (error) {
        debugLog(`CSV解析エラー: ${error.message}`, 'error');
        alert(`CSV読み込みエラー: ${error.message}`);
      }
    }

    // 工具リスト描画
    function renderTools() {
      debugLog('工具リストを描画中');
      const tbody = document.querySelector('#toolTable tbody');
      tbody.innerHTML = "";
      
      if (tools.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">工具が登録されていません</td></tr>';
        return;
      }
      
      for (const tool of tools) {
        const tr = document.createElement('tr');
        
        // 画像
        const imgTd = document.createElement('td');
        if (tool.img) {
          imgTd.innerHTML = `<img class="icon" src="tools/${tool.img}" alt="${tool.name}" 
            onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
            <span style="display:none; font-size:20px;">📋</span>`;
        } else {
          imgTd.innerHTML = `<span style="font-size:20px;">📋</span>`;
        }
        
        tr.appendChild(imgTd);
        tr.innerHTML += `<td><strong>${tool.name}</strong></td>`;
        
        const stockClass = toolStock[tool.name] > 0 ? 'stock-ok' : 'stock-low';
        tr.innerHTML += `<td><span class="${stockClass}">${toolStock[tool.name]}</span></td>`;
        
        // ボタン
        const actionTd = document.createElement('td');
        actionTd.className = "tool-actions";
        
        const borrowBtn = document.createElement('button');
        borrowBtn.textContent = "貸出";
        borrowBtn.className = "btn-borrow";
        borrowBtn.onclick = () => openOperationModal(tool.name, "貸出");
        
        const returnBtn = document.createElement('button');
        returnBtn.textContent = "返却";
        returnBtn.className = "btn-return";
        returnBtn.onclick = () => openOperationModal(tool.name, "返却");
        
        actionTd.appendChild(borrowBtn);
        actionTd.appendChild(returnBtn);
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
      }
      
      debugLog(`工具リスト描画完了: ${tools.length}個の工具`, 'success');
    }

    // 状況テーブル描画
    function renderStatus() {
      let classSet = new Set();
      for (const tool of tools) {
        for (const cls in borrowStatus[tool.name]) {
          if (borrowStatus[tool.name][cls] > 0) {
            classSet.add(cls);
          }
        }
      }
      
      let classes = [...classSet].sort();
      if (classes.length === 0) {
        document.getElementById('statusDiv').innerHTML = '<p class="no-data">現在貸し出し中の工具はありません</p>';
        debugLog('貸出状況: 現在貸出中の工具なし');
        return;
      }
      
      let html = '<table><thead><tr><th>工具名</th>';
      for (const cls of classes) html += `<th>${cls}</th>`;
      html += '<th>在庫</th></tr></thead><tbody>';
      
      let displayCount = 0;
      for (const tool of tools) {
        let hasRow = false;
        let rowHtml = `<td><strong>${tool.name}</strong></td>`;
        
        for (const cls of classes) {
          const count = borrowStatus[tool.name][cls] || 0;
          rowHtml += `<td>${count > 0 ? count : ''}</td>`;
          if (count > 0) hasRow = true;
        }
        
        const stockClass = toolStock[tool.name] > 0 ? 'stock-ok' : 'stock-low';
        rowHtml += `<td><span class="${stockClass}">${toolStock[tool.name]}</span></td>`;
        
        if (hasRow) {
          html += `<tr>${rowHtml}</tr>`;
          displayCount++;
        }
      }
      
      html += '</tbody></table>';
      document.getElementById('statusDiv').innerHTML = html;
      
      debugLog(`貸出状況テーブル描画完了: ${displayCount}個の工具が貸出中`);
    }

    // 履歴テーブル描画
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">履歴はありません</td></tr>';
        return;
      }
      
      // 最新順で表示
      const sortedHistory = [...history].reverse();
      
      for (const record of sortedHistory) {
        const tr = document.createElement('tr');
        const typeClass = record.type === '貸出' ? 'style="color: #ffc107; font-weight: bold;"' : 'style="color: #28a745; font-weight: bold;"';
        tr.innerHTML = `
          <td>${record.date}</td>
          <td><strong>${record.class}</strong></td>
          <td>${record.tool}</td>
          <td><span ${typeClass}>${record.type}</span></td>
          <td>${record.num}</td>
        `;
        tbody.appendChild(tr);
      }
      
      debugLog(`履歴テーブル描画完了: ${history.length}件の履歴`);
    }

    // 操作モーダル
    function openOperationModal(toolName, type) {
      const tool = tools.find(t => t.name === toolName);
      if (!tool) {
        debugLog(`工具が見つかりません: ${toolName}`, 'error');
        return;
      }
      
      debugLog(`操作モーダル開始: ${toolName} - ${type}`);
      
      const maxNum = type === '貸出' ? toolStock[toolName] : 
        Math.max(...Object.values(borrowStatus[toolName] || {}), 0);
      
      if (maxNum <= 0) {
        const message = type === '貸出' ? '在庫がありません' : '貸出中の工具がありません';
        alert(message);
        debugLog(`操作不可: ${message} (${toolName})`, 'warning');
        return;
      }
      
      let html = `
        <h4>${tool.name} - ${type}</h4>
        <form id="modalForm">
          <label>クラス:</label>
          <select name="class" required>
            ${CLASS_LIST.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
          
          <label>本数:</label>
          <input type="number" name="count" min="1" max="${maxNum}" value="1" required>
          
          <button type="submit">${type}する</button>
        </form>
      `;
      
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').style.display = "block";
      
      document.getElementById('modalForm').onsubmit = (e) => {
        e.preventDefault();
        const cls = e.target.class.value;
        const num = parseInt(e.target.count.value, 10);
        doBorrowReturn(toolName, cls, type, num);
        closeModal();
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = "none";
      debugLog('操作モーダルを閉じました');
    }

    // 貸出・返却処理
    function doBorrowReturn(toolName, cls, type, num) {
      debugLog(`${type}処理開始: ${toolName} - ${cls} - ${num}本`);
      
      if (!borrowStatus[toolName]) borrowStatus[toolName] = {};
      if (!borrowStatus[toolName][cls]) borrowStatus[toolName][cls] = 0;
      
      if (type === "貸出") {
        if (num > toolStock[toolName]) {
          const message = "在庫が足りません";
          alert(message);
          debugLog(`貸出失敗: ${message} (要求: ${num}, 在庫: ${toolStock[toolName]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] += num;
        toolStock[toolName] -= num;
        debugLog(`貸出完了: ${cls}に${num}本貸出 (残り在庫: ${toolStock[toolName]})`, 'success');
      } else {
        if (num > borrowStatus[toolName][cls]) {
          const message = "返却数が借りている数を超えています";
          alert(message);
          debugLog(`返却失敗: ${message} (要求: ${num}, 借用中: ${borrowStatus[toolName][cls]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] -= num;
        toolStock[toolName] += num;
        debugLog(`返却完了: ${cls}から${num}本返却 (現在在庫: ${toolStock[toolName]})`, 'success');
      }
      
      // 履歴追加
      const now = new Date();
      const dateStr = now.toLocaleString('ja-JP');
      const newRecord = {
        date: dateStr,
        class: cls,
        tool: toolName,
        type: type,
        num: num
      };
      
      history.unshift(newRecord);
      
      // ローカルストレージに保存
      saveToStorage();
      
      // UI更新
      renderTools();
      renderStatus();
      renderHistory();
      
      debugLog(`操作完了: 履歴に記録し、UIを更新しました`, 'success');
    }

    // localStorage保存
    function saveToStorage() {
      try {
        const data = { borrowStatus, toolStock, history, tools };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        debugLog('データをローカルストレージに保存しました', 'success');
      } catch (error) {
        debugLog(`ローカルストレージ保存エラー: ${error.message}`, 'error');
      }
    }

    // localStorageから復元
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed.borrowStatus) borrowStatus = parsed.borrowStatus;
          if (parsed.toolStock) toolStock = parsed.toolStock;
          if (parsed.history) history = parsed.history;
          if (parsed.tools && tools.length === 0) tools = parsed.tools;
          debugLog('ローカルストレージからデータを復元しました', 'success');
        }
      } catch (error) {
        debugLog(`ローカルストレージ復元エラー: ${error.message}`, 'error');
      }
    }

    // ページ読み込み時の初期化
    window.addEventListener('load', function() {
      debugLog('システム初期化開始');
      loadFromStorage();
      if (tools.length > 0) {
        renderTools();
        renderStatus();
        renderHistory();
        debugLog('既存データでUI初期化完了', 'success');
      }
      debugLog('システム準備完了', 'success');
    });

    // モーダル外クリックで閉じる
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // 初期ログ
    debugLog('工具貸出管理システムが開始されました', 'success');
  </script>
</body>
</html>
