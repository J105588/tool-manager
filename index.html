<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥å…·è²¸ã—å‡ºã—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px; margin: 0 auto; 
      background: white; border-radius: 10px; 
      padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    h1 { color: #333; text-align: center; margin-bottom: 30px; }
    h3 { color: #555; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    
    .csv-section {
      background: #f8f9fa; padding: 20px; border-radius: 8px; 
      margin-bottom: 30px; border-left: 4px solid #28a745;
    }
    .csv-section input[type="file"] { 
      padding: 10px; margin: 10px 0; 
      border: 2px dashed #28a745; border-radius: 4px; 
      background: white; width: 100%; font-size: 16px;
    }
    
    /* é€šçŸ¥ã‚¹ã‚¿ã‚¤ãƒ« */
    .notification {
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      padding: 15px 20px; border-radius: 8px; color: white;
      font-weight: bold; opacity: 0; transform: translateX(100%);
      transition: all 0.3s ease;
      max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
    .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
    .notification.info { background: linear-gradient(135deg, #17a2b8, #007bff); }
    
    /* ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« */
    .debug-console {
      background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace;
      border-radius: 8px; padding: 15px; margin: 20px 0;
      height: 200px; overflow-y: auto; font-size: 12px;
      border: 2px solid #333;
    }
    .debug-console .timestamp { color: #888; }
    .debug-console .success { color: #28a745; }
    .debug-console .error { color: #dc3545; }
    .debug-console .info { color: #17a2b8; }
    .debug-console .warning { color: #ffc107; }
    
    table { 
      width: 100%; border-collapse: collapse; margin-bottom: 30px;
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    th, td { 
      border: 1px solid #e2e8f0; padding: 12px; text-align: center; 
    }
    th { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white; font-weight: bold;
    }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e2e8f0; }
    
    img.icon { 
      width: 40px; height: 40px; object-fit: contain;
      border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tool-actions button { 
      margin: 2px; padding: 8px 16px;
      border: none; border-radius: 4px; cursor: pointer;
      font-weight: bold; transition: all 0.3s;
    }
    .btn-borrow { background: #48bb78; color: white; }
    .btn-borrow:hover { background: #38a169; }
    .btn-return { background: #ed8936; color: white; }
    .btn-return:hover { background: #dd6b20; }
    
    .modal {
      display: none; position: fixed; z-index: 9999; 
      left: 0; top: 0; width: 100vw; height: 100vh; 
      background: rgba(0,0,0,0.5);
    }
    .modal-inner {
      background: white; border-radius: 10px; 
      max-width: 400px; margin: 10% auto; 
      padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      position: relative;
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px; 
      cursor: pointer; font-size: 24px; color: #999;
    }
    .close-btn:hover { color: #333; }
    
    .modal form label {
      display: block; margin: 15px 0 5px 0; 
      font-weight: bold; color: #333;
    }
    .modal form select, .modal form input {
      width: 100%; padding: 10px; border: 1px solid #ddd; 
      border-radius: 4px; font-size: 16px;
    }
    .modal form button {
      width: 100%; background: #667eea; color: white; 
      padding: 12px; border: none; border-radius: 4px; 
      font-size: 16px; font-weight: bold; cursor: pointer;
      margin-top: 20px;
    }
    .modal form button:hover { background: #5a67d8; }
    
    .control-buttons {
      margin: 10px 0;
    }
    .control-buttons button {
      background: #6c757d; color: white; border: none;
      padding: 8px 16px; border-radius: 4px; margin-right: 10px;
      cursor: pointer; font-weight: bold;
    }
    .control-buttons button:hover { background: #545b62; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ å·¥å…·è²¸ã—å‡ºã—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="csv-section">
      <h4>ğŸ“ å·¥å…·ãƒã‚¹ã‚¿CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h4>
      <p><strong>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</strong> å·¥å…·å,æœ¬æ•°,ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å</p>
      <input type="file" id="csvInput" accept=".csv">
      <p style="font-size: 14px; color: #666; margin-top: 10px;">
        ä¾‹: ãƒ‰ãƒ©ã‚¤ãƒãƒ¼,10,driver.png
      </p>
    </div>

    <h3>ğŸ–¥ï¸ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h3>
    <div class="control-buttons">
      <button onclick="clearDebugLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
      <button onclick="exportDebugLog()">ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    </div>
    <div class="debug-console" id="debugConsole">
      <div class="info">[ã‚·ã‚¹ãƒ†ãƒ ] ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹å§‹ã—ã¾ã—ãŸ</div>
    </div>

    <h3>ğŸ“‹ å·¥å…·ä¸€è¦§</h3>
    <table id="toolTable">
      <thead>
        <tr>
          <th>ç”»åƒ</th>
          <th>å·¥å…·å</th>
          <th>åœ¨åº«</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4" style="color: #666; font-style: italic;">
            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
          </td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ“Š è²¸ã—å‡ºã—çŠ¶æ³ä¸€è¦§</h3>
    <div id="statusDiv">
      <p style="text-align:center; color:#666;">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
    </div>

    <h3>ğŸ“œ è²¸å‡ºãƒ»è¿”å´ å±¥æ­´</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>æ—¥æ™‚</th>
          <th>ã‚¯ãƒ©ã‚¹</th>
          <th>å·¥å…·å</th>
          <th>æ“ä½œ</th>
          <th>æœ¬æ•°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5" style="color: #666; font-style: italic;">
            å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- é€šçŸ¥ã‚¨ãƒªã‚¢ -->
  <div id="notificationArea"></div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <span class="close-btn" onclick="closeModal()">Ã—</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    // ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã‚¯ãƒ©ã‚¹åä¸€è¦§
    const CLASS_LIST = ["1", "2", "3", "4", "5", "6", "7", "8"];

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let tools = [];
    let borrowStatus = {}; // {toolå: {classå:æœ¬æ•°, ...}, ...}
    let toolStock = {}; // {toolå: åœ¨åº«æ•°}
    let history = [];
    
    // localStorageã‚­ãƒ¼
    const STORAGE_KEY = "toolsystem-data-v2";

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
    function debugLog(message, type = 'info') {
      const console = document.getElementById('debugConsole');
      const timestamp = new Date().toLocaleString('ja-JP');
      const logEntry = document.createElement('div');
      logEntry.className = type;
      logEntry.innerHTML = `<span class="timestamp">[$$e3RpbWVzdGFtcH1dPC9zcGFuPiA=$${message}`;
      console.appendChild(logEntry);
      console.scrollTop = console.scrollHeight;
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearDebugLog() {
      document.getElementById('debugConsole').innerHTML = 
        '<div class="info">[ã‚·ã‚¹ãƒ†ãƒ ] ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</div>';
      debugLog('ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    }

    function exportDebugLog() {
      const console = document.getElementById('debugConsole');
      const logs = console.innerText;
      const blob = new Blob([logs], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug_log_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      debugLog('ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'info');
    }

    // é€šçŸ¥æ©Ÿèƒ½
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.getElementById('notificationArea').appendChild(notification);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
      setTimeout(() => notification.classList.add('show'), 100);
      
      // è‡ªå‹•å‰Šé™¤
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, duration);
      
      debugLog(`é€šçŸ¥è¡¨ç¤º: ${message}`, type);
    }

    // CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        return;
      }
      
      debugLog(`CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${file.name} (${file.size} bytes)`, 'info');
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${text.length} æ–‡å­—`, 'success');
        parseAndLoadCSV(text);
      };
      reader.onerror = function() {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        showNotification('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      };
      reader.readAsText(file, "UTF-8");
    });

    // CSVè§£æ
    function parseAndLoadCSV(csv) {
      try {
        debugLog('CSVè§£æã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...', 'info');
        
        const lines = csv.trim().split(/\r?\n/);
        debugLog(`CSVãƒ•ã‚¡ã‚¤ãƒ«: ${lines.length} è¡Œæ¤œå‡º`, 'info');
        
        if (lines.length < 2) {
          throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ï¼‰');
        }
        
        const header = lines[0].replace(/\s/g, '').split(',');
        debugLog(`ãƒ˜ãƒƒãƒ€ãƒ¼: ${header.join(', ')}`, 'info');
        
        const KNAME = 'å·¥å…·å', KSTOCK = 'æœ¬æ•°', KIMG = 'ç”»åƒ';
        const nameIndex = header.findIndex(h => h.includes('å·¥å…·') || h.includes('åå‰') || h === 'name');
        const stockIndex = header.findIndex(h => h.includes('æœ¬æ•°') || h.includes('æ•°é‡') || h === 'stock');
        const imgIndex = header.findIndex(h => h.includes('ç”»åƒ') || h.includes('ãƒ•ã‚¡ã‚¤ãƒ«') || h === 'image');
        
        if (nameIndex === -1) {
          throw new Error('å·¥å…·åã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        if (stockIndex === -1) {
          throw new Error('æœ¬æ•°ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        tools = [];
        borrowStatus = {};
        toolStock = {};
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 1; i < lines.length; i++) {
          try {
            const row = lines[i].split(',');
            const toolname = row[nameIndex]?.trim();
            const stock = parseInt(row[stockIndex]?.trim() || "0", 10);
            const img = row[imgIndex]?.trim() || '';
            
            if (!toolname) {
              debugLog(`è¡Œ ${i + 1}: å·¥å…·åãŒç©ºã§ã™ - ã‚¹ã‚­ãƒƒãƒ—`, 'warning');
              continue;
            }
            
            if (isNaN(stock) || stock < 0) {
              debugLog(`è¡Œ ${i + 1}: æœ¬æ•°ãŒç„¡åŠ¹ã§ã™ (${row[stockIndex]}) - 0ã«è¨­å®š`, 'warning');
            }
            
            tools.push({ name: toolname, stock: Math.max(stock, 0), img: img });
            borrowStatus[toolname] = {};
            toolStock[toolname] = Math.max(stock, 0);
            successCount++;
            
            debugLog(`å·¥å…·è¿½åŠ : ${toolname} (åœ¨åº«: ${Math.max(stock, 0)}, ç”»åƒ: ${img || 'ãªã—'})`, 'success');
            
          } catch (error) {
            errorCount++;
            debugLog(`è¡Œ ${i + 1} è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          }
        }
        
        debugLog(`CSVèª­ã¿è¾¼ã¿å®Œäº†: æˆåŠŸ ${successCount}ä»¶, ã‚¨ãƒ©ãƒ¼ ${errorCount}ä»¶`, 'success');
        
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãŸã¾ã¾çŠ¶æ…‹å¾©å…ƒ
        loadFromStorage();
        
        // UIæ›´æ–°
        renderTools();
        renderStatus();
        renderHistory();
        
        // å®Œäº†é€šçŸ¥
        showNotification(`CSVèª­ã¿è¾¼ã¿å®Œäº†ï¼${successCount}å€‹ã®å·¥å…·ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`, 'success', 4000);
        
        if (errorCount > 0) {
          showNotification(`${errorCount}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`, 'warning', 5000);
        }
        
      } catch (error) {
        debugLog(`CSVè§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        showNotification(`CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error', 5000);
      }
    }

    // å·¥å…·ãƒªã‚¹ãƒˆæç”»
    function renderTools() {
      debugLog('å·¥å…·ãƒªã‚¹ãƒˆã‚’æç”»ä¸­...', 'info');
      const tbody = document.querySelector('#toolTable tbody');
      tbody.innerHTML = "";
      
      if (tools.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: #666; font-style: italic;">å·¥å…·ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
        return;
      }
      
      for (const tool of tools) {
        const tr = document.createElement('tr');
        
        // ç”»åƒ
        const imgTd = document.createElement('td');
        if (tool.img) {
          imgTd.innerHTML = `<img class="icon" src="tools/${tool.img}" alt="${tool.name}" 
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="width:40px; height:40px; background:#f3f4f6; display:none; align-items:center; justify-content:center; border-radius:4px; color:#9ca3af;">ğŸ“‹</div>`;
        } else {
          imgTd.innerHTML = `<div style="width:40px; height:40px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; border-radius:4px; color:#9ca3af;">ğŸ“‹</div>`;
        }
        
        tr.appendChild(imgTd);
        tr.innerHTML += `<td><strong>${tool.name}</strong></td>`;
        tr.innerHTML += `<td><span style="color: ${toolStock[tool.name] > 0 ? '#48bb78' : '#e53e3e'}; font-weight: bold;">${toolStock[tool.name]}</span></td>`;
        
        // ãƒœã‚¿ãƒ³
        const actionTd = document.createElement('td');
        actionTd.className = "tool-actions";
        
        const borrowBtn = document.createElement('button');
        borrowBtn.textContent = "è²¸å‡º";
        borrowBtn.className = "btn-borrow";
        borrowBtn.onclick = () => openOperationModal(tool.name, "è²¸å‡º");
        
        const returnBtn = document.createElement('button');
        returnBtn.textContent = "è¿”å´";
        returnBtn.className = "btn-return";
        returnBtn.onclick = () => openOperationModal(tool.name, "è¿”å´");
        
        actionTd.appendChild(borrowBtn);
        actionTd.appendChild(returnBtn);
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
      }
      
      debugLog(`å·¥å…·ãƒªã‚¹ãƒˆæç”»å®Œäº†: ${tools.length}å€‹ã®å·¥å…·`, 'success');
    }

    // çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderStatus() {
      let classSet = new Set();
      for (const tool of tools) {
        for (const cls in borrowStatus[tool.name]) {
          if (borrowStatus[tool.name][cls] > 0) {
            classSet.add(cls);
          }
        }
      }
      
      let classes = [...classSet].sort();
      if (classes.length === 0) {
        document.getElementById('statusDiv').innerHTML = '<p style="text-align:center; color:#666;">ç¾åœ¨è²¸ã—å‡ºã—ä¸­ã®å·¥å…·ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        debugLog('è²¸å‡ºçŠ¶æ³: ç¾åœ¨è²¸å‡ºä¸­ã®å·¥å…·ãªã—', 'info');
        return;
      }
      
      let html = '<table><thead><tr><th>å·¥å…·å</th>';
      for (const cls of classes) html += `<th>${cls}</th>`;
      html += '<th>åœ¨åº«</th></tr></thead><tbody>';
      
      let displayCount = 0;
      for (const tool of tools) {
        let hasRow = false;
        let rowHtml = `<td><strong>${tool.name}</strong></td>`;
        
        for (const cls of classes) {
          const count = borrowStatus[tool.name][cls] || 0;
          rowHtml += `<td>${count > 0 ? count : ''}</td>`;
          if (count > 0) hasRow = true;
        }
        
        rowHtml += `<td><span style="color: ${toolStock[tool.name] > 0 ? '#48bb78' : '#e53e3e'}; font-weight: bold;">${toolStock[tool.name]}</span></td>`;
        
        if (hasRow) {
          html += `<tr>${rowHtml}</tr>`;
          displayCount++;
        }
      }
      
      html += '</tbody></table>';
      document.getElementById('statusDiv').innerHTML = html;
      
      debugLog(`è²¸å‡ºçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†: ${displayCount}å€‹ã®å·¥å…·ãŒè²¸å‡ºä¸­`, 'info');
    }

    // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color: #666; font-style: italic;">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      // æœ€æ–°é †ã§è¡¨ç¤º
      const sortedHistory = [...history].reverse();
      
      for (const record of sortedHistory) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${record.date}</td>
          <td><strong>${record.class}</strong></td>
          <td>${record.tool}</td>
          <td><span style="color: ${record.type === 'è²¸å‡º' ? '#ed8936' : '#48bb78'}; font-weight: bold;">${record.type}</span></td>
          <td>${record.num}</td>
        `;
        tbody.appendChild(tr);
      }
      
      debugLog(`å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†: ${history.length}ä»¶ã®å±¥æ­´`, 'info');
    }

    // æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«
    function openOperationModal(toolName, type) {
      const tool = tools.find(t => t.name === toolName);
      if (!tool) {
        debugLog(`å·¥å…·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${toolName}`, 'error');
        return;
      }
      
      debugLog(`æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«é–‹å§‹: ${toolName} - ${type}`, 'info');
      
      const maxNum = type === 'è²¸å‡º' ? toolStock[toolName] : 
        Math.max(...Object.values(borrowStatus[toolName] || {}), 0);
      
      if (maxNum <= 0) {
        const message = type === 'è²¸å‡º' ? 'åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“' : 'è²¸å‡ºä¸­ã®å·¥å…·ãŒã‚ã‚Šã¾ã›ã‚“';
        showNotification(message, 'warning');
        debugLog(`æ“ä½œä¸å¯: ${message} (${toolName})`, 'warning');
        return;
      }
      
      let html = `
        <h4>${tool.name} - ${type}</h4>
        <form id="modalForm">
          <label>ã‚¯ãƒ©ã‚¹:</label>
          <select name="class" required>
            ${CLASS_LIST.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
          
          <label>æœ¬æ•°:</label>
          <input type="number" name="count" min="1" max="${maxNum}" value="1" required>
          
          <button type="submit">${type}ã™ã‚‹</button>
        </form>
      `;
      
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').style.display = "block";
      
      document.getElementById('modalForm').onsubmit = (e) => {
        e.preventDefault();
        const cls = e.target.class.value;
        const num = parseInt(e.target.count.value, 10);
        doBorrowReturn(toolName, cls, type, num);
        closeModal();
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = "none";
      debugLog('æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ', 'info');
    }

    // è²¸å‡ºãƒ»è¿”å´å‡¦ç†
    function doBorrowReturn(toolName, cls, type, num) {
      debugLog(`${type}å‡¦ç†é–‹å§‹: ${toolName} - ${cls} - ${num}æœ¬`, 'info');
      
      if (!borrowStatus[toolName]) borrowStatus[toolName] = {};
      if (!borrowStatus[toolName][cls]) borrowStatus[toolName][cls] = 0;
      
      if (type === "è²¸å‡º") {
        if (num > toolStock[toolName]) {
          const message = "åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“";
          showNotification(message, 'error');
          debugLog(`è²¸å‡ºå¤±æ•—: ${message} (è¦æ±‚: ${num}, åœ¨åº«: ${toolStock[toolName]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] += num;
        toolStock[toolName] -= num;
        debugLog(`è²¸å‡ºå®Œäº†: ${cls}ã«${num}æœ¬è²¸å‡º (æ®‹ã‚Šåœ¨åº«: ${toolStock[toolName]})`, 'success');
      } else {
        if (num > borrowStatus[toolName][cls]) {
          const message = "è¿”å´æ•°ãŒå€Ÿã‚Šã¦ã„ã‚‹æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™";
          showNotification(message, 'error');
          debugLog(`è¿”å´å¤±æ•—: ${message} (è¦æ±‚: ${num}, å€Ÿç”¨ä¸­: ${borrowStatus[toolName][cls]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] -= num;
        toolStock[toolName] += num;
        debugLog(`è¿”å´å®Œäº†: ${cls}ã‹ã‚‰${num}æœ¬è¿”å´ (ç¾åœ¨åœ¨åº«: ${toolStock[toolName]})`, 'success');
      }
      
      // å±¥æ­´è¿½åŠ 
      const now = new Date();
      const dateStr = now.toLocaleString('ja-JP');
      const newRecord = {
        date: dateStr,
        class: cls,
        tool: toolName,
        type: type,
        num: num
      };
      
      history.unshift(newRecord);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      saveToStorage();
      
      // UIæ›´æ–°
      renderTools();
      renderStatus();
      renderHistory();
      
      // æˆåŠŸé€šçŸ¥
      showNotification(`${type}å®Œäº†: ${toolName} ${num}æœ¬`, 'success');
      debugLog(`æ“ä½œå®Œäº†: å±¥æ­´ã«è¨˜éŒ²ã—ã€UIã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
    }

    // localStorageä¿å­˜
    function saveToStorage() {
      try {
        const data = { borrowStatus, toolStock, history, tools };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        debugLog('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        debugLog(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // localStorageã‹ã‚‰å¾©å…ƒ
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed.borrowStatus) borrowStatus = parsed.borrowStatus;
          if (parsed.toolStock) toolStock = parsed.toolStock;
          if (parsed.history) history = parsed.history;
          if (parsed.tools && tools.length === 0) tools = parsed.tools; // CSVãŒæœªèª­ã¿è¾¼ã¿ã®å ´åˆã®ã¿
          debugLog('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
        }
      } catch (error) {
        debugLog(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('load', function() {
      debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹', 'info');
      loadFromStorage();
      if (tools.length > 0) {
        renderTools();
        renderStatus();
        renderHistory();
        debugLog('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§UIåˆæœŸåŒ–å®Œäº†', 'success');
      }
      debugLog('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // åˆæœŸãƒ­ã‚°
    debugLog('å·¥å…·è²¸å‡ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');
  </script>
</body>
</html>
