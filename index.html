<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥å…·è²¸å‡ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; padding: 20px; 
      background: #f5f5f5;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 8px; 
      padding: 30px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { 
      color: #333; 
      text-align: center; 
      margin-bottom: 30px; 
      border-bottom: 3px solid #007bff;
      padding-bottom: 10px;
    }
    h3 { 
      color: #555; 
      border-bottom: 2px solid #ddd; 
      padding-bottom: 8px; 
      margin-top: 30px;
    }
    
    .csv-section {
      background: #f8f9fa; 
      padding: 20px; 
      border-radius: 5px; 
      margin-bottom: 25px; 
      border: 1px solid #ddd;
    }
    .csv-section input[type="file"] { 
      padding: 8px; 
      margin: 10px 10px 10px 0; 
      border: 1px solid #ccc; 
      border-radius: 4px; 
      background: white; 
      width: 300px;
    }
    .csv-section button {
      background: #007bff; 
      color: white; 
      padding: 10px 20px;
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    .csv-section button:hover { 
      background: #0056b3; 
    }
    .csv-section button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-bottom: 25px;
      border: 1px solid #ddd;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 12px; 
      text-align: center; 
    }
    th { 
      background: #f8f9fa; 
      font-weight: bold;
      color: #495057;
    }
    tr:nth-child(even) { 
      background: #f8f9fa; 
    }
    tr:hover { 
      background: #e9ecef; 
    }
    
    img.icon { 
      width: 40px; 
      height: 40px; 
      object-fit: contain;
      border-radius: 3px;
    }
    
    .tool-actions button { 
      margin: 2px; 
      padding: 6px 12px;
      border: none; 
      border-radius: 3px; 
      cursor: pointer;
      font-size: 12px;
    }
    .btn-borrow { 
      background: #28a745; 
      color: white; 
    }
    .btn-borrow:hover { 
      background: #218838; 
    }
    .btn-return { 
      background: #ffc107; 
      color: #212529; 
    }
    .btn-return:hover { 
      background: #e0a800; 
    }
    
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.4);
    }
    .modal-inner {
      background: white; 
      border-radius: 5px; 
      max-width: 400px; 
      margin: 15% auto; 
      padding: 20px; 
      position: relative;
      border: 1px solid #ddd;
    }
    .close-btn {
      position: absolute; 
      top: 10px; 
      right: 15px; 
      cursor: pointer; 
      font-size: 20px; 
      color: #aaa;
    }
    .close-btn:hover { 
      color: #000; 
    }
    
    .modal form label {
      display: block; 
      margin: 10px 0 5px 0; 
      font-weight: bold;
    }
    .modal form select, .modal form input {
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 3px;
      box-sizing: border-box;
    }
    .modal form button {
      width: 100%; 
      background: #007bff; 
      color: white; 
      padding: 10px; 
      border: none; 
      border-radius: 3px; 
      cursor: pointer;
      margin-top: 15px;
      font-size: 14px;
    }
    .modal form button:hover { 
      background: #0056b3; 
    }

    .no-data {
      color: #6c757d; 
      font-style: italic; 
      text-align: center;
      padding: 20px;
    }

    .stock-low { color: #dc3545; font-weight: bold; }
    .stock-ok { color: #28a745; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ å·¥å…·è²¸ã—å‡ºã—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <div class="csv-section">
      <h4>ğŸ“ å·¥å…·ãƒã‚¹ã‚¿CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h4>
      <p><strong>CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</strong> å·¥å…·å,æœ¬æ•°,ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å</p>
      <input type="file" id="csvInput" accept=".csv">
      <button id="loadCsvBtn" onclick="loadSelectedCSV()" disabled>èª­ã¿è¾¼ã¿</button>
      <p style="font-size: 14px; color: #666; margin-top: 10px;">
        ä¾‹: ãƒ‰ãƒ©ã‚¤ãƒãƒ¼,10,driver.png
      </p>
    </div>

    <h3>ğŸ“‹ å·¥å…·ä¸€è¦§</h3>
    <table id="toolTable">
      <thead>
        <tr>
          <th>ç”»åƒ</th>
          <th>å·¥å…·å</th>
          <th>åœ¨åº«</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4" class="no-data">
            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„
          </td>
        </tr>
      </tbody>
    </table>

    <h3>ğŸ“Š è²¸ã—å‡ºã—çŠ¶æ³ä¸€è¦§</h3>
    <div id="statusDiv">
      <p class="no-data">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
    </div>

    <h3>ğŸ“œ è²¸å‡ºãƒ»è¿”å´ å±¥æ­´</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>æ—¥æ™‚</th>
          <th>ã‚¯ãƒ©ã‚¹</th>
          <th>å·¥å…·å</th>
          <th>æ“ä½œ</th>
          <th>æœ¬æ•°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5" class="no-data">
            å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <span class="close-btn" onclick="closeModal()">Ã—</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    // ãƒ—ãƒªã‚»ãƒƒãƒˆã®ã‚¯ãƒ©ã‚¹åä¸€è¦§
    const CLASS_LIST = ["1", "2", "3", "4", "5", "6", "7", "8"];

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let tools = [];
    let borrowStatus = {}; // {toolå: {classå:æœ¬æ•°, ...}, ...}
    let toolStock = {}; // {toolå: åœ¨åº«æ•°}
    let history = [];
    let selectedFile = null;
    
    // localStorageã‚­ãƒ¼
    const STORAGE_KEY = "toolsystem-data-v2";

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã¿ï¼‰
    function debugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleString('ja-JP');
      const logMessage = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
      
      switch(type) {
        case 'error':
          console.error(logMessage);
          break;
        case 'warning':
          console.warn(logMessage);
          break;
        case 'success':
          console.log(`%c${logMessage}`, 'color: green');
          break;
        default:
          console.log(logMessage);
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    document.getElementById('csvInput').addEventListener('change', function(e) {
      debugLog('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      
      const file = e.target.files[0];
      const loadBtn = document.getElementById('loadCsvBtn');
      
      if (!file) {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
        selectedFile = null;
        loadBtn.disabled = true;
        return;
      }
      
      if (!file.name.toLowerCase().endsWith('.csv')) {
        debugLog('CSVãƒ•ã‚¡ã‚¤ãƒ«ä»¥å¤–ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'warning');
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        e.target.value = '';
        selectedFile = null;
        loadBtn.disabled = true;
        return;
      }
      
      selectedFile = file;
      loadBtn.disabled = false;
      debugLog(`CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå®Œäº†: ${file.name} (${file.size} bytes)`);
    });

    // CSVèª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã®å‡¦ç†
    function loadSelectedCSV() {
      if (!selectedFile) {
        debugLog('èª­ã¿è¾¼ã¿å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      debugLog(`CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${selectedFile.name}`);
      
      const reader = new FileReader();
      
      reader.onloadstart = function() {
        debugLog('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†é–‹å§‹');
        document.getElementById('loadCsvBtn').disabled = true;
        document.getElementById('loadCsvBtn').textContent = 'èª­ã¿è¾¼ã¿ä¸­...';
      };
      
      reader.onload = function(evt) {
        const text = evt.target.result;
        debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${text.length} æ–‡å­—`, 'success');
        parseAndLoadCSV(text);
        
        document.getElementById('loadCsvBtn').disabled = false;
        document.getElementById('loadCsvBtn').textContent = 'èª­ã¿è¾¼ã¿';
      };
      
      reader.onerror = function(error) {
        debugLog(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
        alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        document.getElementById('loadCsvBtn').disabled = false;
        document.getElementById('loadCsvBtn').textContent = 'èª­ã¿è¾¼ã¿';
      };
      
      reader.readAsText(selectedFile, "UTF-8");
    }

    // CSVè§£æ
    function parseAndLoadCSV(csv) {
      try {
        debugLog('CSVè§£æã‚’é–‹å§‹');
        
        const lines = csv.trim().split(/\r?\n/);
        debugLog(`CSVãƒ•ã‚¡ã‚¤ãƒ«: ${lines.length} è¡Œæ¤œå‡º`);
        
        if (lines.length < 2) {
          throw new Error('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ + ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ï¼‰');
        }
        
        const header = lines[0].replace(/\s/g, '').split(',');
        debugLog(`ãƒ˜ãƒƒãƒ€ãƒ¼: ${header.join(', ')}`);
        
        // æŸ”è»Ÿãªãƒ˜ãƒƒãƒ€ãƒ¼æ¤œç´¢
        const nameIndex = header.findIndex(h => 
          h.includes('å·¥å…·') || h.includes('åå‰') || h.includes('name') || h === 'tool'
        );
        const stockIndex = header.findIndex(h => 
          h.includes('æœ¬æ•°') || h.includes('æ•°é‡') || h.includes('stock') || h.includes('count')
        );
        const imgIndex = header.findIndex(h => 
          h.includes('ç”»åƒ') || h.includes('ãƒ•ã‚¡ã‚¤ãƒ«') || h.includes('image') || h.includes('img')
        );
        
        if (nameIndex === -1) {
          throw new Error('å·¥å…·åã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        if (stockIndex === -1) {
          throw new Error('æœ¬æ•°ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        debugLog(`åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ - å·¥å…·å: ${nameIndex}, æœ¬æ•°: ${stockIndex}, ç”»åƒ: ${imgIndex}`);
        
        tools = [];
        borrowStatus = {};
        toolStock = {};
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 1; i < lines.length; i++) {
          try {
            const row = lines[i].split(',');
            const toolname = row[nameIndex]?.trim();
            const stock = parseInt(row[stockIndex]?.trim() || "0", 10);
            const img = imgIndex >= 0 ? (row[imgIndex]?.trim() || '') : '';
            
            if (!toolname) {
              debugLog(`è¡Œ ${i + 1}: å·¥å…·åãŒç©ºã§ã™ - ã‚¹ã‚­ãƒƒãƒ—`, 'warning');
              continue;
            }
            
            if (isNaN(stock) || stock < 0) {
              debugLog(`è¡Œ ${i + 1}: æœ¬æ•°ãŒç„¡åŠ¹ã§ã™ (${row[stockIndex]}) - 0ã«è¨­å®š`, 'warning');
            }
            
            const finalStock = Math.max(stock, 0);
            tools.push({ name: toolname, stock: finalStock, img:img });
            borrowStatus[toolname] = {};
            toolStock[toolname] = finalStock;
            successCount++;
            
            debugLog(`å·¥å…·è¿½åŠ : ${toolname} (åœ¨åº«: ${finalStock}, ç”»åƒ: ${img || 'ãªã—'})`, 'success');
            
          } catch (error) {
            errorCount++;
            debugLog(`è¡Œ ${i + 1} è§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
          }
        }
        
        debugLog(`CSVèª­ã¿è¾¼ã¿å®Œäº†: æˆåŠŸ ${successCount}ä»¶, ã‚¨ãƒ©ãƒ¼ ${errorCount}ä»¶`, 'success');
        
        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ãŸã¾ã¾çŠ¶æ…‹å¾©å…ƒ
        loadFromStorage();
        
        // UIæ›´æ–°
        renderTools();
        renderStatus();
        renderHistory();
        
        // å®Œäº†é€šçŸ¥
        alert(`CSVèª­ã¿è¾¼ã¿å®Œäº†ï¼${successCount}å€‹ã®å·¥å…·ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        
        if (errorCount > 0) {
          alert(`${errorCount}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã—ãŸã€‚è©³ç´°ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„`);
        }
        
      } catch (error) {
        debugLog(`CSVè§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        alert(`CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // å·¥å…·ãƒªã‚¹ãƒˆæç”»
    function renderTools() {
      debugLog('å·¥å…·ãƒªã‚¹ãƒˆã‚’æç”»ä¸­');
      const tbody = document.querySelector('#toolTable tbody');
      tbody.innerHTML = "";
      
      if (tools.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">å·¥å…·ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>';
        return;
      }
      
      for (const tool of tools) {
        const tr = document.createElement('tr');
        
        // ç”»åƒ
        const imgTd = document.createElement('td');
        if (tool.img) {
          imgTd.innerHTML = `<img class="icon" src="tools/${tool.img}" alt="${tool.name}" 
            onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
            <span style="display:none; font-size:20px;">ğŸ“‹</span>`;
        } else {
          imgTd.innerHTML = `<span style="font-size:20px;">ğŸ“‹</span>`;
        }
        
        tr.appendChild(imgTd);
        tr.innerHTML += `<td><strong>${tool.name}</strong></td>`;
        
        const stockClass = toolStock[tool.name] > 0 ? 'stock-ok' : 'stock-low';
        tr.innerHTML += `<td><span class="${stockClass}">${toolStock[tool.name]}</span></td>`;
        
        // ãƒœã‚¿ãƒ³
        const actionTd = document.createElement('td');
        actionTd.className = "tool-actions";
        
        const borrowBtn = document.createElement('button');
        borrowBtn.textContent = "è²¸å‡º";
        borrowBtn.className = "btn-borrow";
        borrowBtn.onclick = () => openOperationModal(tool.name, "è²¸å‡º");
        
        const returnBtn = document.createElement('button');
        returnBtn.textContent = "è¿”å´";
        returnBtn.className = "btn-return";
        returnBtn.onclick = () => openOperationModal(tool.name, "è¿”å´");
        
        actionTd.appendChild(borrowBtn);
        actionTd.appendChild(returnBtn);
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
      }
      
      debugLog(`å·¥å…·ãƒªã‚¹ãƒˆæç”»å®Œäº†: ${tools.length}å€‹ã®å·¥å…·`, 'success');
    }

    // çŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderStatus() {
      let classSet = new Set();
      for (const tool of tools) {
        for (const cls in borrowStatus[tool.name]) {
          if (borrowStatus[tool.name][cls] > 0) {
            classSet.add(cls);
          }
        }
      }
      
      let classes = [...classSet].sort();
      if (classes.length === 0) {
        document.getElementById('statusDiv').innerHTML = '<p class="no-data">ç¾åœ¨è²¸ã—å‡ºã—ä¸­ã®å·¥å…·ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        debugLog('è²¸å‡ºçŠ¶æ³: ç¾åœ¨è²¸å‡ºä¸­ã®å·¥å…·ãªã—');
        return;
      }
      
      let html = '<table><thead><tr><th>å·¥å…·å</th>';
      for (const cls of classes) html += `<th>${cls}</th>`;
      html += '<th>åœ¨åº«</th></tr></thead><tbody>';
      
      let displayCount = 0;
      for (const tool of tools) {
        let hasRow = false;
        let rowHtml = `<td><strong>${tool.name}</strong></td>`;
        
        for (const cls of classes) {
          const count = borrowStatus[tool.name][cls] || 0;
          rowHtml += `<td>${count > 0 ? count : ''}</td>`;
          if (count > 0) hasRow = true;
        }
        
        const stockClass = toolStock[tool.name] > 0 ? 'stock-ok' : 'stock-low';
        rowHtml += `<td><span class="${stockClass}">${toolStock[tool.name]}</span></td>`;
        
        if (hasRow) {
          html += `<tr>${rowHtml}</tr>`;
          displayCount++;
        }
      }
      
      html += '</tbody></table>';
      document.getElementById('statusDiv').innerHTML = html;
      
      debugLog(`è²¸å‡ºçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†: ${displayCount}å€‹ã®å·¥å…·ãŒè²¸å‡ºä¸­`);
    }

    // å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }
      
      // æœ€æ–°é †ã§è¡¨ç¤º
      const sortedHistory = [...history].reverse();
      
      for (const record of sortedHistory) {
        const tr = document.createElement('tr');
        const typeClass = record.type === 'è²¸å‡º' ? 'style="color: #ffc107; font-weight: bold;"' : 'style="color: #28a745; font-weight: bold;"';
        tr.innerHTML = `
          <td>${record.date}</td>
          <td><strong>${record.class}</strong></td>
          <td>${record.tool}</td>
          <td><span ${typeClass}>${record.type}</span></td>
          <td>${record.num}</td>
        `;
        tbody.appendChild(tr);
      }
      
      debugLog(`å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«æç”»å®Œäº†: ${history.length}ä»¶ã®å±¥æ­´`);
    }

    // æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«
    function openOperationModal(toolName, type) {
      const tool = tools.find(t => t.name === toolName);
      if (!tool) {
        debugLog(`å·¥å…·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${toolName}`, 'error');
        return;
      }
      
      debugLog(`æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«é–‹å§‹: ${toolName} - ${type}`);
      
      const maxNum = type === 'è²¸å‡º' ? toolStock[toolName] : 
        Math.max(...Object.values(borrowStatus[toolName] || {}), 0);
      
      if (maxNum <= 0) {
        const message = type === 'è²¸å‡º' ? 'åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“' : 'è²¸å‡ºä¸­ã®å·¥å…·ãŒã‚ã‚Šã¾ã›ã‚“';
        alert(message);
        debugLog(`æ“ä½œä¸å¯: ${message} (${toolName})`, 'warning');
        return;
      }
      
      let html = `
        <h4>${tool.name} - ${type}</h4>
        <form id="modalForm">
          <label>ã‚¯ãƒ©ã‚¹:</label>
          <select name="class" required>
            ${CLASS_LIST.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
          
          <label>æœ¬æ•°:</label>
          <input type="number" name="count" min="1" max="${maxNum}" value="1" required>
          
          <button type="submit">${type}ã™ã‚‹</button>
        </form>
      `;
      
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').style.display = "block";
      
      document.getElementById('modalForm').onsubmit = (e) => {
        e.preventDefault();
        const cls = e.target.class.value;
        const num = parseInt(e.target.count.value, 10);
        doBorrowReturn(toolName, cls, type, num);
        closeModal();
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = "none";
      debugLog('æ“ä½œãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
    }

    // è²¸å‡ºãƒ»è¿”å´å‡¦ç†
    function doBorrowReturn(toolName, cls, type, num) {
      debugLog(`${type}å‡¦ç†é–‹å§‹: ${toolName} - ${cls} - ${num}æœ¬`);
      
      if (!borrowStatus[toolName]) borrowStatus[toolName] = {};
      if (!borrowStatus[toolName][cls]) borrowStatus[toolName][cls] = 0;
      
      if (type === "è²¸å‡º") {
        if (num > toolStock[toolName]) {
          const message = "åœ¨åº«ãŒè¶³ã‚Šã¾ã›ã‚“";
          alert(message);
          debugLog(`è²¸å‡ºå¤±æ•—: ${message} (è¦æ±‚: ${num}, åœ¨åº«: ${toolStock[toolName]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] += num;
        toolStock[toolName] -= num;
        debugLog(`è²¸å‡ºå®Œäº†: ${cls}ã«${num}æœ¬è²¸å‡º (æ®‹ã‚Šåœ¨åº«: ${toolStock[toolName]})`, 'success');
      } else {
        if (num > borrowStatus[toolName][cls]) {
          const message = "è¿”å´æ•°ãŒå€Ÿã‚Šã¦ã„ã‚‹æ•°ã‚’è¶…ãˆã¦ã„ã¾ã™";
          alert(message);
          debugLog(`è¿”å´å¤±æ•—: ${message} (è¦æ±‚: ${num}, å€Ÿç”¨ä¸­: ${borrowStatus[toolName][cls]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] -= num;
        toolStock[toolName] += num;
        debugLog(`è¿”å´å®Œäº†: ${cls}ã‹ã‚‰${num}æœ¬è¿”å´ (ç¾åœ¨åœ¨åº«: ${toolStock[toolName]})`, 'success');
      }
      
      // å±¥æ­´è¿½åŠ 
      const now = new Date();
      const dateStr = now.toLocaleString('ja-JP');
      const newRecord = {
        date: dateStr,
        class: cls,
        tool: toolName,
        type: type,
        num: num
      };
      
      history.unshift(newRecord);
      
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      saveToStorage();
      
      // UIæ›´æ–°
      renderTools();
      renderStatus();
      renderHistory();
      
      debugLog(`æ“ä½œå®Œäº†: å±¥æ­´ã«è¨˜éŒ²ã—ã€UIã‚’æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
    }

    // localStorageä¿å­˜
    function saveToStorage() {
      try {
        const data = { borrowStatus, toolStock, history, tools };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        debugLog('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¾ã—ãŸ', 'success');
      } catch (error) {
        debugLog(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // localStorageã‹ã‚‰å¾©å…ƒ
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed.borrowStatus) borrowStatus = parsed.borrowStatus;
          if (parsed.toolStock) toolStock = parsed.toolStock;
          if (parsed.history) history = parsed.history;
          if (parsed.tools && tools.length === 0) tools = parsed.tools;
          debugLog('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
        }
      } catch (error) {
        debugLog(`ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å¾©å…ƒã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('load', function() {
      debugLog('ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
      loadFromStorage();
      if (tools.length > 0) {
        renderTools();
        renderStatus();
        renderHistory();
        debugLog('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§UIåˆæœŸåŒ–å®Œäº†', 'success');
      }
      debugLog('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†', 'success');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // åˆæœŸãƒ­ã‚°
    debugLog('å·¥å…·è²¸å‡ºç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');
  </script>
</body>
</html>
