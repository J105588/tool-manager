<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>工具貸し出し管理システム</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px; margin: 0 auto; 
      background: white; border-radius: 10px; 
      padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    h1 { color: #333; text-align: center; margin-bottom: 30px; }
    h3 { color: #555; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
    
    .csv-section {
      background: #f8f9fa; padding: 20px; border-radius: 8px; 
      margin-bottom: 30px; border-left: 4px solid #28a745;
    }
    .csv-section input[type="file"] { 
      padding: 10px; margin: 10px 0; 
      border: 2px dashed #28a745; border-radius: 4px; 
      background: white; width: 100%; font-size: 16px;
    }
    
    /* 通知スタイル */
    .notification {
      position: fixed; top: 20px; right: 20px; z-index: 10000;
      padding: 15px 20px; border-radius: 8px; color: white;
      font-weight: bold; opacity: 0; transform: translateX(100%);
      transition: all 0.3s ease;
      max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .notification.show { opacity: 1; transform: translateX(0); }
    .notification.success { background: linear-gradient(135deg, #28a745, #20c997); }
    .notification.error { background: linear-gradient(135deg, #dc3545, #e74c3c); }
    .notification.info { background: linear-gradient(135deg, #17a2b8, #007bff); }
    
    /* デバッグコンソール */
    .debug-console {
      background: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace;
      border-radius: 8px; padding: 15px; margin: 20px 0;
      height: 200px; overflow-y: auto; font-size: 12px;
      border: 2px solid #333;
    }
    .debug-console .timestamp { color: #888; }
    .debug-console .success { color: #28a745; }
    .debug-console .error { color: #dc3545; }
    .debug-console .info { color: #17a2b8; }
    .debug-console .warning { color: #ffc107; }
    
    table { 
      width: 100%; border-collapse: collapse; margin-bottom: 30px;
      background: white; border-radius: 8px; overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    th, td { 
      border: 1px solid #e2e8f0; padding: 12px; text-align: center; 
    }
    th { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white; font-weight: bold;
    }
    tr:nth-child(even) { background: #f8f9fa; }
    tr:hover { background: #e2e8f0; }
    
    img.icon { 
      width: 40px; height: 40px; object-fit: contain;
      border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tool-actions button { 
      margin: 2px; padding: 8px 16px;
      border: none; border-radius: 4px; cursor: pointer;
      font-weight: bold; transition: all 0.3s;
    }
    .btn-borrow { background: #48bb78; color: white; }
    .btn-borrow:hover { background: #38a169; }
    .btn-return { background: #ed8936; color: white; }
    .btn-return:hover { background: #dd6b20; }
    
    .modal {
      display: none; position: fixed; z-index: 9999; 
      left: 0; top: 0; width: 100vw; height: 100vh; 
      background: rgba(0,0,0,0.5);
    }
    .modal-inner {
      background: white; border-radius: 10px; 
      max-width: 400px; margin: 10% auto; 
      padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      position: relative;
    }
    .close-btn {
      position: absolute; top: 10px; right: 15px; 
      cursor: pointer; font-size: 24px; color: #999;
    }
    .close-btn:hover { color: #333; }
    
    .modal form label {
      display: block; margin: 15px 0 5px 0; 
      font-weight: bold; color: #333;
    }
    .modal form select, .modal form input {
      width: 100%; padding: 10px; border: 1px solid #ddd; 
      border-radius: 4px; font-size: 16px;
    }
    .modal form button {
      width: 100%; background: #667eea; color: white; 
      padding: 12px; border: none; border-radius: 4px; 
      font-size: 16px; font-weight: bold; cursor: pointer;
      margin-top: 20px;
    }
    .modal form button:hover { background: #5a67d8; }
    
    .control-buttons {
      margin: 10px 0;
    }
    .control-buttons button {
      background: #6c757d; color: white; border: none;
      padding: 8px 16px; border-radius: 4px; margin-right: 10px;
      cursor: pointer; font-weight: bold;
    }
    .control-buttons button:hover { background: #545b62; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 工具貸し出し管理システム</h1>
    
    <div class="csv-section">
      <h4>📁 工具マスタCSVファイル読み込み</h4>
      <p><strong>CSVフォーマット:</strong> 工具名,本数,画像ファイル名</p>
      <input type="file" id="csvInput" accept=".csv">
      <p style="font-size: 14px; color: #666; margin-top: 10px;">
        例: ドライバー,10,driver.png
      </p>
    </div>

    <h3>🖥️ デバッグコンソール</h3>
    <div class="control-buttons">
      <button onclick="clearDebugLog()">ログクリア</button>
      <button onclick="exportDebugLog()">ログエクスポート</button>
    </div>
    <div class="debug-console" id="debugConsole">
      <div class="info">[システム] デバッグコンソールを開始しました</div>
    </div>

    <h3>📋 工具一覧</h3>
    <table id="toolTable">
      <thead>
        <tr>
          <th>画像</th>
          <th>工具名</th>
          <th>在庫</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4" style="color: #666; font-style: italic;">
            CSVファイルを読み込んでください
          </td>
        </tr>
      </tbody>
    </table>

    <h3>📊 貸し出し状況一覧</h3>
    <div id="statusDiv">
      <p style="text-align:center; color:#666;">CSVファイルを読み込んでください</p>
    </div>

    <h3>📜 貸出・返却 履歴</h3>
    <table id="historyTable">
      <thead>
        <tr>
          <th>日時</th>
          <th>クラス</th>
          <th>工具名</th>
          <th>操作</th>
          <th>本数</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="5" style="color: #666; font-style: italic;">
            履歴はありません
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 通知エリア -->
  <div id="notificationArea"></div>

  <!-- モーダル -->
  <div class="modal" id="modal">
    <div class="modal-inner">
      <span class="close-btn" onclick="closeModal()">×</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    // プリセットのクラス名一覧
    const CLASS_LIST = ["1", "2", "3", "4", "5", "6", "7", "8"];

    // グローバル変数
    let tools = [];
    let borrowStatus = {}; // {tool名: {class名:本数, ...}, ...}
    let toolStock = {}; // {tool名: 在庫数}
    let history = [];
    
    // localStorageキー
    const STORAGE_KEY = "toolsystem-data-v2";

    // デバッグログ機能
    function debugLog(message, type = 'info') {
      const console = document.getElementById('debugConsole');
      const timestamp = new Date().toLocaleString('ja-JP');
      const logEntry = document.createElement('div');
      logEntry.className = type;
      logEntry.innerHTML = `<span class="timestamp">[$$e3RpbWVzdGFtcH1dPC9zcGFuPiA=$${message}`;
      console.appendChild(logEntry);
      console.scrollTop = console.scrollHeight;
      
      // コンソールにも出力
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearDebugLog() {
      document.getElementById('debugConsole').innerHTML = 
        '<div class="info">[システム] ログをクリアしました</div>';
      debugLog('デバッグログをクリアしました', 'info');
    }

    function exportDebugLog() {
      const console = document.getElementById('debugConsole');
      const logs = console.innerText;
      const blob = new Blob([logs], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug_log_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      debugLog('デバッグログをエクスポートしました', 'info');
    }

    // 通知機能
    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      document.getElementById('notificationArea').appendChild(notification);
      
      // アニメーション表示
      setTimeout(() => notification.classList.add('show'), 100);
      
      // 自動削除
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, duration);
      
      debugLog(`通知表示: ${message}`, type);
    }

    // CSVファイル読み込み
    document.getElementById('csvInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) {
        debugLog('ファイルが選択されていません', 'warning');
        return;
      }
      
      debugLog(`CSVファイル読み込み開始: ${file.name} (${file.size} bytes)`, 'info');
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        const text = evt.target.result;
        debugLog(`ファイル読み込み完了: ${text.length} 文字`, 'success');
        parseAndLoadCSV(text);
      };
      reader.onerror = function() {
        debugLog('ファイル読み込みエラーが発生しました', 'error');
        showNotification('ファイル読み込みに失敗しました', 'error');
      };
      reader.readAsText(file, "UTF-8");
    });

    // CSV解析
    function parseAndLoadCSV(csv) {
      try {
        debugLog('CSV解析を開始しています...', 'info');
        
        const lines = csv.trim().split(/\r?\n/);
        debugLog(`CSVファイル: ${lines.length} 行検出`, 'info');
        
        if (lines.length < 2) {
          throw new Error('CSVファイルにデータが不足しています（ヘッダー + データ行が必要）');
        }
        
        const header = lines[0].replace(/\s/g, '').split(',');
        debugLog(`ヘッダー: ${header.join(', ')}`, 'info');
        
        const KNAME = '工具名', KSTOCK = '本数', KIMG = '画像';
        const nameIndex = header.findIndex(h => h.includes('工具') || h.includes('名前') || h === 'name');
        const stockIndex = header.findIndex(h => h.includes('本数') || h.includes('数量') || h === 'stock');
        const imgIndex = header.findIndex(h => h.includes('画像') || h.includes('ファイル') || h === 'image');
        
        if (nameIndex === -1) {
          throw new Error('工具名の列が見つかりません');
        }
        if (stockIndex === -1) {
          throw new Error('本数の列が見つかりません');
        }
        
        tools = [];
        borrowStatus = {};
        toolStock = {};
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 1; i < lines.length; i++) {
          try {
            const row = lines[i].split(',');
            const toolname = row[nameIndex]?.trim();
            const stock = parseInt(row[stockIndex]?.trim() || "0", 10);
            const img = row[imgIndex]?.trim() || '';
            
            if (!toolname) {
              debugLog(`行 ${i + 1}: 工具名が空です - スキップ`, 'warning');
              continue;
            }
            
            if (isNaN(stock) || stock < 0) {
              debugLog(`行 ${i + 1}: 本数が無効です (${row[stockIndex]}) - 0に設定`, 'warning');
            }
            
            tools.push({ name: toolname, stock: Math.max(stock, 0), img: img });
            borrowStatus[toolname] = {};
            toolStock[toolname] = Math.max(stock, 0);
            successCount++;
            
            debugLog(`工具追加: ${toolname} (在庫: ${Math.max(stock, 0)}, 画像: ${img || 'なし'})`, 'success');
            
          } catch (error) {
            errorCount++;
            debugLog(`行 ${i + 1} 解析エラー: ${error.message}`, 'error');
          }
        }
        
        debugLog(`CSV読み込み完了: 成功 ${successCount}件, エラー ${errorCount}件`, 'success');
        
        // 既存データを保持したまま状態復元
        loadFromStorage();
        
        // UI更新
        renderTools();
        renderStatus();
        renderHistory();
        
        // 完了通知
        showNotification(`CSV読み込み完了！${successCount}個の工具を登録しました`, 'success', 4000);
        
        if (errorCount > 0) {
          showNotification(`${errorCount}件のエラーがありました。詳細はデバッグコンソールを確認してください`, 'warning', 5000);
        }
        
      } catch (error) {
        debugLog(`CSV解析エラー: ${error.message}`, 'error');
        showNotification(`CSV読み込みエラー: ${error.message}`, 'error', 5000);
      }
    }

    // 工具リスト描画
    function renderTools() {
      debugLog('工具リストを描画中...', 'info');
      const tbody = document.querySelector('#toolTable tbody');
      tbody.innerHTML = "";
      
      if (tools.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="color: #666; font-style: italic;">工具が登録されていません</td></tr>';
        return;
      }
      
      for (const tool of tools) {
        const tr = document.createElement('tr');
        
        // 画像
        const imgTd = document.createElement('td');
        if (tool.img) {
          imgTd.innerHTML = `<img class="icon" src="tools/${tool.img}" alt="${tool.name}" 
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div style="width:40px; height:40px; background:#f3f4f6; display:none; align-items:center; justify-content:center; border-radius:4px; color:#9ca3af;">📋</div>`;
        } else {
          imgTd.innerHTML = `<div style="width:40px; height:40px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; border-radius:4px; color:#9ca3af;">📋</div>`;
        }
        
        tr.appendChild(imgTd);
        tr.innerHTML += `<td><strong>${tool.name}</strong></td>`;
        tr.innerHTML += `<td><span style="color: ${toolStock[tool.name] > 0 ? '#48bb78' : '#e53e3e'}; font-weight: bold;">${toolStock[tool.name]}</span></td>`;
        
        // ボタン
        const actionTd = document.createElement('td');
        actionTd.className = "tool-actions";
        
        const borrowBtn = document.createElement('button');
        borrowBtn.textContent = "貸出";
        borrowBtn.className = "btn-borrow";
        borrowBtn.onclick = () => openOperationModal(tool.name, "貸出");
        
        const returnBtn = document.createElement('button');
        returnBtn.textContent = "返却";
        returnBtn.className = "btn-return";
        returnBtn.onclick = () => openOperationModal(tool.name, "返却");
        
        actionTd.appendChild(borrowBtn);
        actionTd.appendChild(returnBtn);
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
      }
      
      debugLog(`工具リスト描画完了: ${tools.length}個の工具`, 'success');
    }

    // 状況テーブル描画
    function renderStatus() {
      let classSet = new Set();
      for (const tool of tools) {
        for (const cls in borrowStatus[tool.name]) {
          if (borrowStatus[tool.name][cls] > 0) {
            classSet.add(cls);
          }
        }
      }
      
      let classes = [...classSet].sort();
      if (classes.length === 0) {
        document.getElementById('statusDiv').innerHTML = '<p style="text-align:center; color:#666;">現在貸し出し中の工具はありません</p>';
        debugLog('貸出状況: 現在貸出中の工具なし', 'info');
        return;
      }
      
      let html = '<table><thead><tr><th>工具名</th>';
      for (const cls of classes) html += `<th>${cls}</th>`;
      html += '<th>在庫</th></tr></thead><tbody>';
      
      let displayCount = 0;
      for (const tool of tools) {
        let hasRow = false;
        let rowHtml = `<td><strong>${tool.name}</strong></td>`;
        
        for (const cls of classes) {
          const count = borrowStatus[tool.name][cls] || 0;
          rowHtml += `<td>${count > 0 ? count : ''}</td>`;
          if (count > 0) hasRow = true;
        }
        
        rowHtml += `<td><span style="color: ${toolStock[tool.name] > 0 ? '#48bb78' : '#e53e3e'}; font-weight: bold;">${toolStock[tool.name]}</span></td>`;
        
        if (hasRow) {
          html += `<tr>${rowHtml}</tr>`;
          displayCount++;
        }
      }
      
      html += '</tbody></table>';
      document.getElementById('statusDiv').innerHTML = html;
      
      debugLog(`貸出状況テーブル描画完了: ${displayCount}個の工具が貸出中`, 'info');
    }

    // 履歴テーブル描画
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML = "";
      
      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color: #666; font-style: italic;">履歴はありません</td></tr>';
        return;
      }
      
      // 最新順で表示
      const sortedHistory = [...history].reverse();
      
      for (const record of sortedHistory) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${record.date}</td>
          <td><strong>${record.class}</strong></td>
          <td>${record.tool}</td>
          <td><span style="color: ${record.type === '貸出' ? '#ed8936' : '#48bb78'}; font-weight: bold;">${record.type}</span></td>
          <td>${record.num}</td>
        `;
        tbody.appendChild(tr);
      }
      
      debugLog(`履歴テーブル描画完了: ${history.length}件の履歴`, 'info');
    }

    // 操作モーダル
    function openOperationModal(toolName, type) {
      const tool = tools.find(t => t.name === toolName);
      if (!tool) {
        debugLog(`工具が見つかりません: ${toolName}`, 'error');
        return;
      }
      
      debugLog(`操作モーダル開始: ${toolName} - ${type}`, 'info');
      
      const maxNum = type === '貸出' ? toolStock[toolName] : 
        Math.max(...Object.values(borrowStatus[toolName] || {}), 0);
      
      if (maxNum <= 0) {
        const message = type === '貸出' ? '在庫がありません' : '貸出中の工具がありません';
        showNotification(message, 'warning');
        debugLog(`操作不可: ${message} (${toolName})`, 'warning');
        return;
      }
      
      let html = `
        <h4>${tool.name} - ${type}</h4>
        <form id="modalForm">
          <label>クラス:</label>
          <select name="class" required>
            ${CLASS_LIST.map(c => `<option value="${c}">${c}</option>`).join("")}
          </select>
          
          <label>本数:</label>
          <input type="number" name="count" min="1" max="${maxNum}" value="1" required>
          
          <button type="submit">${type}する</button>
        </form>
      `;
      
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('modal').style.display = "block";
      
      document.getElementById('modalForm').onsubmit = (e) => {
        e.preventDefault();
        const cls = e.target.class.value;
        const num = parseInt(e.target.count.value, 10);
        doBorrowReturn(toolName, cls, type, num);
        closeModal();
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = "none";
      debugLog('操作モーダルを閉じました', 'info');
    }

    // 貸出・返却処理
    function doBorrowReturn(toolName, cls, type, num) {
      debugLog(`${type}処理開始: ${toolName} - ${cls} - ${num}本`, 'info');
      
      if (!borrowStatus[toolName]) borrowStatus[toolName] = {};
      if (!borrowStatus[toolName][cls]) borrowStatus[toolName][cls] = 0;
      
      if (type === "貸出") {
        if (num > toolStock[toolName]) {
          const message = "在庫が足りません";
          showNotification(message, 'error');
          debugLog(`貸出失敗: ${message} (要求: ${num}, 在庫: ${toolStock[toolName]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] += num;
        toolStock[toolName] -= num;
        debugLog(`貸出完了: ${cls}に${num}本貸出 (残り在庫: ${toolStock[toolName]})`, 'success');
      } else {
        if (num > borrowStatus[toolName][cls]) {
          const message = "返却数が借りている数を超えています";
          showNotification(message, 'error');
          debugLog(`返却失敗: ${message} (要求: ${num}, 借用中: ${borrowStatus[toolName][cls]})`, 'error');
          return;
        }
        borrowStatus[toolName][cls] -= num;
        toolStock[toolName] += num;
        debugLog(`返却完了: ${cls}から${num}本返却 (現在在庫: ${toolStock[toolName]})`, 'success');
      }
      
      // 履歴追加
      const now = new Date();
      const dateStr = now.toLocaleString('ja-JP');
      const newRecord = {
        date: dateStr,
        class: cls,
        tool: toolName,
        type: type,
        num: num
      };
      
      history.unshift(newRecord);
      
      // ローカルストレージに保存
      saveToStorage();
      
      // UI更新
      renderTools();
      renderStatus();
      renderHistory();
      
      // 成功通知
      showNotification(`${type}完了: ${toolName} ${num}本`, 'success');
      debugLog(`操作完了: 履歴に記録し、UIを更新しました`, 'success');
    }

    // localStorage保存
    function saveToStorage() {
      try {
        const data = { borrowStatus, toolStock, history, tools };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        debugLog('データをローカルストレージに保存しました', 'success');
      } catch (error) {
        debugLog(`ローカルストレージ保存エラー: ${error.message}`, 'error');
      }
    }

    // localStorageから復元
    function loadFromStorage() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        if (data) {
          const parsed = JSON.parse(data);
          if (parsed.borrowStatus) borrowStatus = parsed.borrowStatus;
          if (parsed.toolStock) toolStock = parsed.toolStock;
          if (parsed.history) history = parsed.history;
          if (parsed.tools && tools.length === 0) tools = parsed.tools; // CSVが未読み込みの場合のみ
          debugLog('ローカルストレージからデータを復元しました', 'success');
        }
      } catch (error) {
        debugLog(`ローカルストレージ復元エラー: ${error.message}`, 'error');
      }
    }

    // ページ読み込み時の初期化
    window.addEventListener('load', function() {
      debugLog('システム初期化開始', 'info');
      loadFromStorage();
      if (tools.length > 0) {
        renderTools();
        renderStatus();
        renderHistory();
        debugLog('既存データでUI初期化完了', 'success');
      }
      debugLog('システム準備完了', 'success');
    });

    // モーダル外クリックで閉じる
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    // 初期ログ
    debugLog('工具貸出管理システムが開始されました', 'success');
  </script>
</body>
</html>
